<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Pasteurization of Milk - Time, Temperature, and Safety</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com?plugins=typography"></script>

  <!-- p5.js -->
  <script src="https://cdn.jsdelivr.net/npm/p5@1.9.2/lib/p5.min.js"></script>

  <style>
    :root {
      --teal-main: #0f766e;
      --teal-soft: #5eead4;
      --bg-soft: #f4fbfa;
      --ink: #0f172a;
      --muted: #6b7280;
      --danger: #dc2626;
      --warn: #f97316;
      --safe: #22c55e;
      --milk-bg: #eff6ff;
    }

    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
      background: radial-gradient(circle at top, #e0fbff 0, #f9fafb 60%);
      color: var(--ink);
    }

    .glass-card {
      border-radius: 1.4rem;
      background: rgba(255, 255, 255, 0.98);
      box-shadow:
        0 16px 40px rgba(15, 23, 42, 0.12),
        0 0 0 1px rgba(148, 163, 253, 0.06);
      backdrop-filter: blur(14px);
    }

    .chip {
      display: inline-flex;
      align-items: center;
      gap: 0.35rem;
      padding: 0.25rem 0.75rem;
      border-radius: 999px;
      font-size: 0.66rem;
      letter-spacing: 0.12em;
      text-transform: uppercase;
      color: var(--teal-main);
      background: linear-gradient(
        to right,
        rgba(15, 118, 110, 0.08),
        rgba(56, 189, 248, 0.02)
      );
      border: 1px solid rgba(15, 118, 110, 0.18);
    }

    .chip span.dot {
      width: 0.4rem;
      height: 0.4rem;
      border-radius: 999px;
      background: var(--teal-soft);
      box-shadow: 0 0 10px rgba(94, 234, 212, 0.9);
    }

    .pill {
      display: inline-flex;
      align-items: center;
      gap: 0.26rem;
      padding: 0.18rem 0.6rem;
      border-radius: 999px;
      font-size: 0.64rem;
      color: var(--muted);
      background-color: rgba(15, 118, 110, 0.03);
    }

    .pill-color {
      width: 0.5rem;
      height: 0.5rem;
      border-radius: 999px;
    }

    #sketch-container {
      border-radius: 1rem;
      overflow: hidden;
      background: radial-gradient(circle at top, #e0f2fe, #ffffff);
      border: 1px solid rgba(148, 163, 253, 0.16);
      position: relative;
    }

    .overlay-label {
      position: absolute;
      right: 0.7rem;
      top: 0.5rem;
      padding: 0.16rem 0.6rem;
      border-radius: 999px;
      font-size: 0.6rem;
      background: rgba(255, 255, 255, 0.96);
      color: var(--teal-main);
      display: inline-flex;
      align-items: center;
      gap: 0.3rem;
      box-shadow: 0 4px 10px rgba(148, 163, 253, 0.2);
    }

    .overlay-label span.swatch {
      width: 0.4rem;
      height: 0.4rem;
      border-radius: 999px;
      background: var(--teal-main);
    }

    .btn-step {
      padding: 0.4rem 0.9rem;
      font-size: 0.7rem;
      border-radius: 999px;
      border: 1px solid rgba(15, 118, 110, 0.18);
      background-color: rgba(240, 253, 250, 0.98);
      color: var(--teal-main);
      display: inline-flex;
      align-items: center;
      gap: 0.35rem;
      cursor: pointer;
      transition: all 0.18s ease-out;
      white-space: nowrap;
    }

    .btn-step:hover {
      background-color: rgba(209, 250, 229, 0.98);
      box-shadow: 0 4px 10px rgba(148, 163, 253, 0.16);
    }

    .btn-step.primary {
      background-color: var(--teal-main);
      color: #ffffff;
      border-color: transparent;
    }

    .btn-step.primary:hover {
      background-color: #115e59;
      box-shadow: 0 5px 14px rgba(15, 23, 42, 0.22);
    }

    .slider-label {
      font-size: 0.65rem;
      color: var(--muted);
    }

    input[type="range"] {
      -webkit-appearance: none;
      width: 140px;
      height: 4px;
      border-radius: 999px;
      background: #e5e7eb;
      outline: none;
      cursor: pointer;
    }

    input[type="range"]::-webkit-slider-thumb {
      -webkit-appearance: none;
      width: 16px;
      height: 16px;
      border-radius: 999px;
      background: var(--teal-main);
      border: 2px solid #ecfeff;
      box-shadow: 0 0 8px rgba(15, 118, 110, 0.6);
      transition: all 0.16s ease-out;
    }

    input[type="range"]::-webkit-slider-thumb:hover {
      transform: scale(1.08);
      box-shadow: 0 0 14px rgba(15, 118, 110, 0.8);
    }

    .status-label {
      font-size: 0.66rem;
      color: var(--muted);
    }

    .explain-list {
      font-size: 0.7rem;
      color: var(--muted);
    }

    .explain-list li {
      margin-bottom: 0.12rem;
    }

    .metric-label {
      font-size: 0.65rem;
      color: var(--muted);
    }

    .metric-value {
      font-size: 0.9rem;
      font-weight: 600;
      color: var(--teal-main);
    }

    .metric-sub {
      font-size: 0.62rem;
      color: #9ca3af;
    }
  </style>
</head>
<body class="min-h-screen flex justify-center px-4 py-6">
  <main class="w-full max-w-6xl space-y-5">
    <!-- Header -->
    <section class="glass-card px-6 py-4 flex flex-col gap-3 md:flex-row md:items-center md:justify-between">
      <div class="space-y-1.5">
        <div class="chip">
          <span class="dot"></span>
          Louis Pasteur • Pasteurization Lab
        </div>
        <h1 class="text-xl md:text-2xl font-semibold text-slate-900">
          Finding the sweet spot: heating milk enough to be safe, not enough to ruin it
        </h1>
        <p class="text-xs md:text-sm text-slate-600 max-w-2xl">
          Adjust the time–temperature combination to explore how pasteurization reduces pathogens while preserving shelf life and quality, echoing Pasteur’s core insight.
        </p>
      </div>
      <div class="flex flex-col items-end gap-1">
        <div class="pill">
          <span class="pill-color" style="background:#dc2626;"></span>
          Red dots = pathogenic microbes
        </div>
        <div class="pill">
          <span class="pill-color" style="background:#f97316;"></span>
          Amber dots = spoilage microbes
        </div>
        <div class="pill">
          <span class="pill-color" style="background:#38bdf8;"></span>
          Blue dots = nutrients / quality
        </div>
        <div class="status-label text-right">
          Goal: ≥5-log pathogen kill with high nutrient and quality retention.
        </div>
      </div>
    </section>

    <section class="grid gap-4 md:grid-cols-[minmax(0,_1.9fr)_minmax(260px,_1.1fr)] items-stretch">
      <!-- LEFT: Simulation -->
      <div class="glass-card p-4 flex flex-col gap-3">
        <!-- Legend -->
        <div class="flex flex-wrap gap-2 text-[0.65rem] text-slate-600">
          <div class="pill">
            <span class="pill-color" style="background:#dc2626;"></span>
            Pathogens to remove
          </div>
          <div class="pill">
            <span class="pill-color" style="background:#f97316;"></span>
            Spoilage microbes
          </div>
          <div class="pill">
            <span class="pill-color" style="background:#38bdf8;"></span>
            Nutrients & quality markers
          </div>
        </div>

        <!-- Canvas -->
        <div id="sketch-container" class="mt-1 w-full aspect-[16/9]">
          <div class="overlay-label">
            <span class="swatch"></span>
            Milk column under heat treatment
          </div>
        </div>

        <!-- Controls -->
        <div class="mt-3 flex flex-wrap items-center gap-3 text-xs">
          <button id="btnClassic" class="btn-step primary">
            72°C for 15 s (HTST)
          </button>
          <button id="btnUHT" class="btn-step">
            UHT: 135°C for 2 s
          </button>
          <button id="btnMild" class="btn-step">
            Mild: 60°C for 15 s
          </button>
          <button id="btnReset" class="btn-step">
            ⟳ Reset
          </button>
        </div>

        <div class="mt-2 flex flex-wrap items-center gap-4 text-xs">
          <div class="flex items-center gap-2">
            <div>
              <div class="slider-label font-semibold text-[0.65rem] text-[var(--teal-main)] uppercase tracking-wide">
                Temperature
              </div>
              <div class="slider-label">Set holding temperature (°C)</div>
            </div>
            <input id="tempSlider" type="range" min="40" max="150" value="72" />
            <div class="status-label">
              <span id="tempValue">72</span>°C
            </div>
          </div>

          <div class="flex items-center gap-2">
            <div>
              <div class="slider-label font-semibold text-[0.65rem] text-sky-700 uppercase tracking-wide">
                Holding time
              </div>
              <div class="slider-label">At / above target (s)</div>
            </div>
            <input id="timeSlider" type="range" min="0" max="60" value="15" />
            <div class="status-label">
              <span id="timeValue">15</span>s
            </div>
          </div>

          <div class="pill">
            Status:
            <span id="safetyLabel" class="status-label">Not yet evaluated</span>
          </div>
        </div>

        <!-- Summary -->
        <p id="summaryText" class="mt-1 text-[0.7rem] leading-relaxed text-slate-600">
          Start with a full microbial load. Try the HTST preset (72°C for 15 s) and watch red pathogen dots disappear,
          while most blue nutrient markers remain. Increase heat or time further to see safety improve at the cost of quality.
        </p>
      </div>

      <!-- RIGHT: Explanation -->
      <aside class="glass-card p-4 flex flex-col gap-3">
        <!-- Snapshot -->
        <div class="border border-slate-100 rounded-xl px-3 py-2.5 space-y-1.5">
          <div class="text-[0.65rem] font-semibold tracking-wide text-[var(--teal-main)] uppercase flex items-center gap-1.5">
            <span class="w-1.5 h-1.5 rounded-full bg-[var(--teal-main)]"></span>
            Pasteurization at a glance
          </div>
          <ul class="explain-list list-disc pl-4">
            <li>Targets pathogens with a defined time–temperature combo.</li>
            <li>Reduces spoilage microbes to extend shelf life.</li>
            <li>Aims to preserve taste and nutrients: this is pasteurization, not full sterilization.</li>
          </ul>
        </div>

        <!-- Metrics -->
        <div class="grid grid-cols-2 gap-2 text-xs">
          <div class="bg-[var(--bg-soft)]/80 border border-slate-100 rounded-xl px-2.5 py-2">
            <div class="metric-label">Pathogen reduction</div>
            <div id="metricPathogen" class="metric-value">0.0-log</div>
            <div id="metricSafeNote" class="metric-sub text-[var(--danger)]">Below target</div>
          </div>
          <div class="bg-[var(--bg-soft)]/60 border border-slate-100 rounded-xl px-2.5 py-2">
            <div class="metric-label">Spoilage reduction</div>
            <div id="metricSpoilage" class="metric-value">0.0-log</div>
            <div class="metric-sub">Shelf life impact</div>
          </div>
          <div class="bg-sky-50/70 border border-sky-100 rounded-xl px-2.5 py-2">
            <div class="metric-label">Nutrient retention</div>
            <div id="metricNutrient" class="metric-value">100%</div>
            <div class="metric-sub">Vitamins / enzymes</div>
          </div>
          <div class="bg-emerald-50/80 border border-emerald-100 rounded-xl px-2.5 py-2">
            <div class="metric-label">Quality score</div>
            <div id="metricQuality" class="metric-value">100%</div>
            <div class="metric-sub">Flavor & proteins</div>
          </div>
        </div>

        <!-- How it works -->
        <div class="border border-slate-100 rounded-xl px-3 py-2.5 space-y-1">
          <div class="text-[0.65rem] font-semibold tracking-wide text-sky-700 uppercase flex items-center gap-1.5">
            <span class="w-1.5 h-1.5 rounded-full bg-sky-400"></span>
            How this model behaves
          </div>
          <ul class="explain-list list-disc pl-4">
            <li>Above ~60°C, microbes die exponentially; hotter and longer means more log-reduction.</li>
            <li>We mark ≥5-log pathogen reduction as “safe” for pasteurization.</li>
            <li>Nutrient and quality scores gently decline as you push temperature/time higher.</li>
          </ul>
        </div>

        <!-- Quick experiments -->
        <div class="border border-slate-100 rounded-xl px-3 py-2.5 space-y-1.5">
          <div class="text-[0.65rem] font-semibold tracking-wide text-emerald-700 uppercase flex items-center gap-1.5">
            <span class="w-1.5 h-1.5 rounded-full bg-emerald-400"></span>
            Try these scenarios
          </div>
          <ol class="explain-list list-decimal pl-4 space-y-0.5">
            <li>60°C for 15 s: note poor pathogen kill despite excellent quality.</li>
            <li>72°C for 15 s (HTST): hits safety target with high retention.</li>
            <li>90°C for 40 s: very safe, but nutrient/quality scores drop.</li>
            <li>UHT 135°C for 2 s: near-complete kill; compare to shelf-stable milk.</li>
          </ol>
          <p class="text-[0.65rem] text-slate-500 leading-relaxed">
            Use the visuals plus the metrics to separate intuition (“hotter feels safer”) from the controlled balance Pasteur introduced.
          </p>
        </div>
      </aside>
    </section>
  </main>

  <script>
    // Simple pedagogical model for pasteurization:
    // - Time/temperature -> log reduction for pathogens & spoilage
    // - Higher T/time -> more kill, but more nutrient/quality loss

    const sim = {
      temp: 72,
      time: 15,
      logP: 0,
      logS: 0,
      nutrient: 1,
      quality: 1
    };

    // Parameters (schematic, not clinical)
    const ref = {
      refTemp: 72,
      Dp_ref: 2.5,   // s for 1-log pathogen kill at 72°C
      Ds_ref: 5.0,   // s for 1-log spoilage kill at 72°C
      zp: 7,         // °C for 10x change in D (pathogens)
      zs: 8,         // °C for 10x change in D (spoilage)
      safeLog: 5
    };

    const tempSlider = document.getElementById("tempSlider");
    const timeSlider = document.getElementById("timeSlider");
    const tempValue = document.getElementById("tempValue");
    const timeValue = document.getElementById("timeValue");
    const summaryText = document.getElementById("summaryText");
    const safetyLabel = document.getElementById("safetyLabel");

    const metricPathogen = document.getElementById("metricPathogen");
    const metricSpoilage = document.getElementById("metricSpoilage");
    const metricNutrient = document.getElementById("metricNutrient");
    const metricQuality = document.getElementById("metricQuality");
    const metricSafeNote = document.getElementById("metricSafeNote");

    const btnClassic = document.getElementById("btnClassic");
    const btnUHT = document.getElementById("btnUHT");
    const btnMild = document.getElementById("btnMild");
    const btnReset = document.getElementById("btnReset");

    function computeD(D_ref, T_ref, z, T) {
      return D_ref * Math.pow(10, (T_ref - T) / z);
    }

    function recomputeModel() {
      const T = sim.temp;
      const t = sim.time;

      if (T < 50 || t <= 0) {
        sim.logP = 0;
        sim.logS = 0;
        sim.nutrient = 1;
        sim.quality = 1;
        updateUI();
        return;
      }

      const Dp = computeD(ref.Dp_ref, ref.refTemp, ref.zp, T);
      const Ds = computeD(ref.Ds_ref, ref.refTemp, ref.zs, T);

      sim.logP = Math.max(0, Math.min(t / Dp, 12));
      sim.logS = Math.max(0, Math.min(t / Ds, 12));

      // Nutrient loss: modest below ~72, then steeper
      let nutrientLoss = 0;
      if (T <= 72) {
        nutrientLoss = Math.min(0.12, (t / 300) * 0.1);
      } else {
        const sev = (T - 72) / 40;
        nutrientLoss = Math.min(0.1 + sev * sev * (t / 60) * 0.6, 0.8);
      }
      sim.nutrient = Math.max(0.2, 1 - nutrientLoss);

      // Quality loss: more sensitive at high T/time
      let qLoss = 0;
      if (T <= 80) {
        qLoss = Math.min(0.12, (t / 300) * 0.08);
      } else {
        const sevQ = (T - 80) / 50;
        qLoss = Math.min(0.12 + sevQ * sevQ * (t / 40) * 0.9, 0.9);
      }
      sim.quality = Math.max(0.1, 1 - qLoss);

      updateUI();
    }

    function updateUI() {
      const lp = sim.logP;
      const ls = sim.logS;
      const n = Math.round(sim.nutrient * 100);
      const q = Math.round(sim.quality * 100);
      const safe = lp >= ref.safeLog;

      metricPathogen.textContent = lp.toFixed(1) + "-log";
      metricSpoilage.textContent = ls.toFixed(1) + "-log";
      metricNutrient.textContent = n + "%";
      metricQuality.textContent = q + "%";

      if (safe) {
        metricSafeNote.textContent = "Meets ≥5-log safety target";
        metricSafeNote.style.color = "var(--safe)";
        safetyLabel.textContent = "Pasteurization target reached";
      } else {
        metricSafeNote.textContent = "Below 5-log target";
        metricSafeNote.style.color = "var(--danger)";
        safetyLabel.textContent = "Not yet at safe pasteurization level";
      }

      let text = `With ${sim.temp.toFixed(0)}°C for ${sim.time.toFixed(0)} s: `;

      if (!safe) {
        text += `pathogen reduction is only ${lp.toFixed(
          1
        )}-log, so safety is inadequate, even though nutrients (${n}%) and quality (${q}%) remain high.`;
      } else if (safe && ls < 3) {
        text += `you reach pasteurization-level pathogen kill (${lp.toFixed(
          1
        )}-log), but spoilage microbes are less reduced (${ls.toFixed(
          1
        )}-log), so shelf life is modest. Quality stays around ${q}%.`;
      } else if (lp > 8 && (n < 60 || q < 60)) {
        text += `you are far beyond typical pasteurization (${lp.toFixed(
          1
        )}-log). Safety is excellent, but nutrients (${n}%) and sensory quality (${q}%) drop—closer to overcooked or UHT milk.`;
      } else {
        text += `this is a balanced window: about ${lp.toFixed(
          1
        )}-log pathogen reduction with ${n}% nutrient retention and ${q}% quality, illustrating Pasteur’s idea of “enough heat, not too much”.`;
      }

      summaryText.textContent = text;
    }

    // Event bindings
    tempSlider.addEventListener("input", () => {
      sim.temp = parseInt(tempSlider.value, 10);
      tempValue.textContent = sim.temp.toString();
      recomputeModel();
      resetParticles();
    });

    timeSlider.addEventListener("input", () => {
      sim.time = parseInt(timeSlider.value, 10);
      timeValue.textContent = sim.time.toString();
      recomputeModel();
      resetParticles();
    });

    btnClassic.addEventListener("click", () => {
      sim.temp = 72;
      sim.time = 15;
      tempSlider.value = 72;
      timeSlider.value = 15;
      tempValue.textContent = "72";
      timeValue.textContent = "15";
      recomputeModel();
      resetParticles();
    });

    btnUHT.addEventListener("click", () => {
      sim.temp = 135;
      sim.time = 2;
      tempSlider.value = 135;
      timeSlider.value = 2;
      tempValue.textContent = "135";
      timeValue.textContent = "2";
      recomputeModel();
      resetParticles();
    });

    btnMild.addEventListener("click", () => {
      sim.temp = 60;
      sim.time = 15;
      tempSlider.value = 60;
      timeSlider.value = 15;
      tempValue.textContent = "60";
      timeValue.textContent = "15";
      recomputeModel();
      resetParticles();
    });

    btnReset.addEventListener("click", () => {
      sim.temp = 72;
      sim.time = 15;
      tempSlider.value = 72;
      timeSlider.value = 15;
      tempValue.textContent = "72";
      timeValue.textContent = "15";
      recomputeModel();
      resetParticles();
    });

    // p5.js visualization of milk column
    let canvasRef;
    let pathogens = [];
    let spoilage = [];
    let nutrients = [];

    function setup() {
      const container = document.getElementById("sketch-container");
      const rect = container.getBoundingClientRect();
      canvasRef = createCanvas(rect.width, rect.height);
      canvasRef.parent("sketch-container");
      resetParticles();
      recomputeModel();
    }

    function windowResized() {
      const container = document.getElementById("sketch-container");
      if (!container) return;
      const rect = container.getBoundingClientRect();
      resizeCanvas(rect.width, rect.height);
      resetParticles();
    }

    function resetParticles() {
      pathogens = [];
      spoilage = [];
      nutrients = [];

      const cx = width / 2;
      const topY = height * 0.16;
      const bottomY = height * 0.9;
      const leftX = width * 0.2;
      const rightX = width * 0.8;

      // Pathogens (red)
      for (let i = 0; i < 70; i++) {
        pathogens.push({
          x: random(leftX, rightX),
          y: random(topY, bottomY),
          alive: true,
          phase: random(TWO_PI)
        });
      }

      // Spoilage (amber)
      for (let i = 0; i < 70; i++) {
        spoilage.push({
          x: random(leftX, rightX),
          y: random(topY, bottomY),
          alive: true,
          phase: random(TWO_PI)
        });
      }

      // Nutrients / quality (blue)
      for (let i = 0; i < 80; i++) {
        nutrients.push({
          x: random(leftX, rightX),
          y: random(topY, bottomY),
          intact: true,
          phase: random(TWO_PI)
        });
      }
    }

    function drawMilkBackground() {
      background(248, 250, 252);

      const leftX = width * 0.2;
      const rightX = width * 0.8;
      const topY = height * 0.16;
      const bottomY = height * 0.9;

      // Glass outline
      noFill();
      stroke(148, 163, 253, 160);
      strokeWeight(1.2);
      rect(leftX, topY, rightX - leftX, bottomY - topY, 22);

      // Milk fill
      noStroke();
      for (let y = topY + 6; y < bottomY - 4; y++) {
        const t = (y - topY) / (bottomY - topY);
        const c = lerpColor(
          color(239, 246, 255, 240),
          color(226, 232, 240, 235),
          t * 0.6
        );
        fill(c);
        rect(leftX + 2, y, rightX - leftX - 4, 1);
      }

      // Highlight stripe
      fill(255, 255, 255, 120);
      rect(leftX + 6, topY + 10, 6, bottomY - topY - 30, 12);
    }

    function drawParticles() {
      const leftX = width * 0.2 + 4;
      const rightX = width * 0.8 - 4;
      const topY = height * 0.16 + 10;
      const bottomY = height * 0.9 - 6;

      const heatFactor = constrain((sim.temp - 40) / 80, 0, 1.6);
      const lp = sim.logP;
      const ls = sim.logS;
      const nRet = sim.nutrient;
      const qRet = sim.quality;

      // Pathogens
      for (let p of pathogens) {
        if (!p.alive) continue;

        p.phase += 0.02 + heatFactor * 0.03;
        p.x += sin(p.phase) * (0.3 + heatFactor * 0.4);
        p.y += cos(p.phase * 0.8) * (0.2 + heatFactor * 0.3);

        if (p.x < leftX) p.x = leftX;
        if (p.x > rightX) p.x = rightX;
        if (p.y < topY) p.y = topY;
        if (p.y > bottomY) p.y = bottomY;

        // Kill based on log reduction
        if (lp > 0) {
          const survival = Math.pow(10, -lp);
          const frameKillProb = (1 - survival) * 0.02;
          if (random() < frameKillProb) {
            p.alive = false;
            continue;
          }
        }

        fill(220, 38, 38, 220);
        circle(p.x, p.y, 4);
      }

      // Dead pathogens (faint)
      for (let p of pathogens) {
        if (!p.alive) {
          fill(220, 38, 38, 60);
          circle(p.x, p.y, 2.4);
        }
      }

      // Spoilage
      for (let s of spoilage) {
        if (!s.alive) continue;

        s.phase += 0.018 + heatFactor * 0.025;
        s.x += sin(s.phase) * (0.25 + heatFactor * 0.3);
        s.y += cos(s.phase * 0.9) * (0.18 + heatFactor * 0.25);

        if (s.x < leftX) s.x = leftX;
        if (s.x > rightX) s.x = rightX;
        if (s.y < topY) s.y = topY;
        if (s.y > bottomY) s.y = bottomY;

        if (ls > 0) {
          const survival = Math.pow(10, -ls);
          const frameKillProb = (1 - survival) * 0.015;
          if (random() < frameKillProb) {
            s.alive = false;
            continue;
          }
        }

        fill(249, 115, 22, 210);
        circle(s.x, s.y, 3.4);
      }

      for (let s of spoilage) {
        if (!s.alive) {
          fill(249, 115, 22, 50);
          circle(s.x, s.y, 2.2);
        }
      }

      // Nutrients / quality markers
      for (let n of nutrients) {
        if (!n.intact) continue;

        n.phase += 0.015;
        n.x += sin(n.phase) * 0.2;
        n.y += cos(n.phase * 0.7) * 0.12;

        if (n.x < leftX) n.x = leftX;
        if (n.x > rightX) n.x = rightX;
        if (n.y < topY) n.y = topY;
        if (n.y > bottomY) n.y = bottomY;

        if (random() > nRet && random() < 0.01) {
          n.intact = false;
          continue;
        }

        fill(56, 189, 248, 215);
        circle(n.x, n.y, 2.6);
      }

      // Faded lost nutrients
      for (let n of nutrients) {
        if (!n.intact) {
          fill(148, 163, 253, 40);
          circle(n.x, n.y, 2.0);
        }
      }
    }

    function drawOverlay() {
      const lp = sim.logP;
      const safe = lp >= ref.safeLog;

      const padX = 10;
      const padY = 8;

      // Temperature badge
      noStroke();
      fill(255, 255, 255, 230);
      rect(padX, padY, 92, 34, 14);
      fill(15, 23, 42);
      textAlign(LEFT, TOP);
      textSize(10);
      text(`${sim.temp.toFixed(0)}°C`, padX + 8, padY + 6);
      fill(107, 114, 128);
      textSize(7.5);
      text("Holding temperature", padX + 8, padY + 19);

      // Time badge
      const padX2 = padX + 96;
      fill(255, 255, 255, 230);
      rect(padX2, padY, 80, 34, 14);
      fill(15, 23, 42);
      textSize(10);
      text(`${sim.time.toFixed(0)} s`, padX2 + 8, padY + 6);
      fill(107, 114, 128);
      textSize(7.5);
      text("At / above T", padX2 + 8, padY + 19);

      // Safety badge
      const padX3 = width - 126;
      fill(255, 255, 255, 235);
      rect(padX3, padY, 116, 34, 16);
      textAlign(LEFT, TOP);
      if (safe) {
        fill(34, 197, 94);
        textSize(9);
        text("Pasteurized ✓", padX3 + 10, padY + 6);
        fill(107, 114, 128);
        textSize(7.4);
        text(`${lp.toFixed(1)}-log pathogens`, padX3 + 10, padY + 18);
      } else {
        fill(220, 38, 38);
        textSize(9);
        text("Not safe ✕", padX3 + 10, padY + 6);
        fill(107, 114, 128);
        textSize(7.4);
        text(`Only ${lp.toFixed(1)}-log kill`, padX3 + 10, padY + 18);
      }

      // Bottom hint
      textAlign(CENTER, BOTTOM);
      textSize(7.5);
      fill(148, 163, 253);
      text(
        "Dot density ≈ microbes; blue markers ≈ quality. Pasteurization: enough kill with minimal loss.",
        width / 2,
        height - 8
      );
    }

    function draw() {
      drawMilkBackground();
      drawParticles();
      drawOverlay();
    }
  </script>
</body>
</html>